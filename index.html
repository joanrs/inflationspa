<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Inflación - España</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Calculadora de Inflación 2018-2025. España</h1>
        <p class="mb-4">Esta calculadora utiliza datos reales del IPC (Índice de Precios al Consumo) de España para mostrar el efecto de la inflación en sus ahorros.</p>

        <!-- Form Section -->
        <div id="formSection">
            <form id="calcForm">
                <div class="mb-3">
                    <label for="initial_savings" class="form-label">Ahorros iniciales €:</label>
                    <input type="number" class="form-control" id="initial_savings" name="initial_savings" required>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="start_month" class="form-label">Fecha de inicio:</label>
                        <div class="input-group">
                            <select class="form-select" id="start_month" name="start_month" required>
                                <option value="01">01</option>
                                <option value="02">02</option>
                                <option value="03">03</option>
                                <option value="04">04</option>
                                <option value="05">05</option>
                                <option value="06">06</option>
                                <option value="07">07</option>
                                <option value="08">08</option>
                                <option value="09">09</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                            <select class="form-select" id="start_year" name="start_year" required>
                                <option value="2020">2018</option>
                                <option value="2020">2019</option>
                                <option value="2020">2020</option>
                                <option value="2021">2021</option>
                                <option value="2022">2022</option>
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="end_month" class="form-label">Fecha de fin:</label>
                        <div class="input-group">
                            <select class="form-select" id="end_month" name="end_month" required>
                                <option value="01">01</option>
                                <option value="02">02</option>
                                <option value="03">03</option>
                                <option value="04">04</option>
                                <option value="05">05</option>
                                <option value="06">06</option>
                                <option value="07">07</option>
                                <option value="08">08</option>
                                <option value="09">09</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                            <select class="form-select" id="end_year" name="end_year" required>
                                <option value="2020">2018</option>
                                <option value="2020">2019</option>
                                <option value="2020">2020</option>
                                <option value="2021">2021</option>
                                <option value="2022">2022</option>
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">Calcular</button>
            </form>
        </div>

        <!-- Results Section (Hidden Initially) -->
        <div id="resultsSection" style="display: none;">
            <div class="card mb-4">
                <div class="card-body">
                    <p><strong>Ahorros iniciales:</strong> <span id="initial_savings_display"></span> €</p>
                    <p><strong>Fecha de inicio:</strong> <span id="start_date"></span></p>
                    <p><strong>Fecha de fin:</strong> <span id="end_date"></span></p>
                    <p><strong>Ahorros finales después de la inflación:</strong> <span id="final_savings"></span> €</p>
                    <p><strong>Pérdida de poder adquisitivo:</strong> <span id="loss"></span> € (<span id="ipcOh"></span>%)</p>
                    <p><strong>IPC acumulado en el período:</strong> <span id="cumulative_ipc"></span>%</p>
                </div>
            </div>

            <h2 class="mb-3">Datos de IPC utilizados:</h2>
            <div class="card mb-4">
                <div class="card-body" id="ipc_badges"></div>
            </div>

            <h2 class="mb-3">Gráfica del IPC en el período seleccionado</h2>
            <div class="chart-container mb-4">
                <canvas id="ipcChartResults"></canvas>
            </div>

            <button id="recalculate" class="btn btn-primary">Volver a calcular</button>

            <div class="card mb-4">
                <div class="card-body">
                    <h3 class="card-title">Fórmula utilizada:</h3>
                    <p>Para cada mes, aplicamos la siguiente fórmula:</p>
                    <div class="formula text-center my-3">
                        \[S_n = \frac{S_{n-1}}{(1 + \frac{i_n}{1200})}\]
                    </div>
                    <p>Donde:</p>
                    <ul class="list-unstyled">
                        <li>\(S_n\) = Ahorros al final del mes n</li>
                        <li>\(S_{n-1}\) = Ahorros al inicio del mes n (o final del mes anterior)</li>
                        <li>\(i_n\) = IPC del mes n %</li>
                        <li>1200 = Factor de conversión (12 meses * 100 para convertir de porcentaje a decimal)</li>
                    </ul>
                    <p>Esta fórmula se aplica de manera iterativa para cada mes del período seleccionado.</p>
                </div>
            </div>
        </div>

        <!-- Historical IPC Chart -->
        <h2 class="mt-4">Gráfica del IPC en España</h2>
        <div class="chart-container">
            <canvas id="ipcChart"></canvas>
        </div>

        <!-- Embed Inflation Data -->
        <script id="inflation-data" type="application/json">
            {
                "2018": {"01": 0.6,"02": 1.1,"03": 1.2,"04": 1.1,"05": 2.1,"06": 2.3,"07": 2.2,"08": 2.2,"09": 2.3,"10": 2.3,"11": 1.7,"12": 1.2},
                "2019": {"01": 1.0,"02": 1.1,"03": 1.3,"04": 1.5,"05": 0.8,"06": 0.4,"07": 0.5,"08": 0.3,"09": 0.1,"10": 0.1,"11": 0.4,"12": 0.8},
                "2020": {"01": 1.1, "02": 0.7, "03": 0, "04": -0.7, "05": -0.9, "06": -0.3, "07": -0.6, "08": -0.5, "09": -0.4, "10": -0.8, "11": -0.8, "12": -0.5},
                "2021": {"01": 0.5, "02": 0, "03": 1.3, "04": 2.2, "05": 2.7, "06": 2.7, "07": 2.9, "08": 3.3, "09": 4.0, "10": 5.4, "11": 5.5, "12": 6.5},
                "2022": {"01": 6.1, "02": 7.6, "03": 9.8, "04": 8.3, "05": 8.7, "06": 10.2, "07": 10.8, "08": 10.5, "09": 8.9, "10": 7.3, "11": 6.8, "12": 5.7},
                "2023": {"01": 5.9, "02": 6.0, "03": 3.3, "04": 4.1, "05": 3.2, "06": 1.9, "07": 2.3, "08": 2.6, "09": 3.5, "10": 3.5, "11": 3.2, "12": 3.1},
                "2024": {"01": 2.8, "02": 3.4, "03": 3.2, "04": 3.3, "05": 3.6, "06": 3.4, "07": 2.8, "08": 2.3, "09": 2.4, "10": 1.8, "11": 2.4, "12": 2.8},
                "2025": {"01": 2.9, "02": 3, "03": 2.3, "04": 2.2}
            }
        </script>
    </div>

    <script>
        const formSection = document.getElementById('formSection');
        const resultsSection = document.getElementById('resultsSection');
        const calcForm = document.getElementById('calcForm');
        const recalculateBtn = document.getElementById('recalculate');

        // Toggle between form and results
        function showForm() {
            formSection.style.display = 'block';
            resultsSection.style.display = 'none';
            calcForm.reset();
        }

        function showResults() {
            formSection.style.display = 'none';
            resultsSection.style.display = 'block';
        }

        // Form submission
        calcForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(calcForm);
            const data = {
                initial_savings: formData.get('initial_savings'),
                start_month: formData.get('start_month'),
                start_year: formData.get('start_year'),
                end_month: formData.get('end_month'),
                end_year: formData.get('end_year')
            };

            try {
                const response = await fetch('/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (response.ok) {
                    // Update results
                    document.getElementById('initial_savings_display').textContent = result.initial_savings;
                    document.getElementById('start_date').textContent = result.start_date;
                    document.getElementById('end_date').textContent = result.end_date;
                    document.getElementById('final_savings').textContent = result.final_savings;
                    document.getElementById('loss').textContent = result.loss;
                    document.getElementById('ipcOh').textContent = result.ipcOh;
                    document.getElementById('cumulative_ipc').textContent = result.cumulative_ipc;

                    // Update IPC badges
                    const badgesContainer = document.getElementById('ipc_badges');
                    badgesContainer.innerHTML = '';
                    result.ipc_data.forEach(item => {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-primary me-2 mb-2';
                        badge.textContent = `${item.date.slice(-2)}-${item.date.slice(0,4)}: ${item.ipc}%`;
                        badgesContainer.appendChild(badge);
                    });

                    // Update results chart
                    const ctx = document.getElementById('ipcChartResults').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: result.ipc_data.map(item => item.date),
                            datasets: [{
                                label: 'IPC (%)',
                                data: result.ipc_data.map(item => item.ipc),
                                borderColor: 'rgb(75, 192, 192)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    ticks: {
                                        maxRotation: 90,
                                        minRotation: 90
                                    }
                                },
                                y: {
                                    beginAtZero: false
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'IPC durante el período seleccionado'
                                }
                            }
                        }
                    });

                    showResults();
                } else {
                    alert(result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // Recalculate button
        recalculateBtn.addEventListener('click', showForm);
    </script>
</body>
</html>